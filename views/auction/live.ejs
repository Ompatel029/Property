<% layout("/layouts/boilerplate")%>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
    .auction-card {
        border: 2px solid #e0e0e0;
        border-radius: 15px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .auction-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        border-color: #fe424d;
    }
    
    .auction-live {
        border-color: #28a745 !important;
        background: linear-gradient(135deg, #f8f9fa 0%, #e8f5e8 100%);
    }
    
    .auction-ending-soon {
        border-color: #ffc107 !important;
        background: linear-gradient(135deg, #f8f9fa 0%, #fff8e1 100%);
    }
    
    .auction-ended {
        border-color: #dc3545 !important;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffe6e6 100%);
        opacity: 0.7;
    }
    
    .status-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
        z-index: 2;
    }
    
    .live-badge {
        background: #28a745;
        color: white;
        animation: pulse 2s infinite;
    }
    
    .ending-soon-badge {
        background: #ffc107;
        color: #000;
        animation: blink 1s infinite;
    }
    
    .ended-badge {
        background: #dc3545;
        color: white;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0.5; }
    }
    
    .timer {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        font-size: 1.1rem;
    }
    
    .bid-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
    }
    
    .current-bid {
        font-size: 1.5rem;
        font-weight: bold;
        color: #28a745;
    }
    
    .bid-button {
        background: #fe424d;
        border: none;
        color: white;
        border-radius: 25px;
        padding: 8px 20px;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    .bid-button:hover {
        background: #e63946;
        transform: scale(1.05);
    }
    
    .property-image {
        height: 200px;
        object-fit: cover;
        border-radius: 10px;
    }
    
    .page-header {
        background: linear-gradient(135deg, #fe424d 0%, #ff6b7a 100%);
        color: white;
        padding: 40px 0;
        text-align: center;
        margin-bottom: 30px;
    }
</style>

<!-- Page Header -->
<div class="page-header">
    <div class="container">
        <h1><i class="fas fa-gavel"></i> Live Property Auctions</h1>
        <p class="lead">Bid on premium properties in real-time</p>
    </div>
</div>

<div class="container">
    <!-- Auction Listings -->
    <div class="row" id="auctionContainer">
        <% if (auctions.length === 0) { %>
            <div class="col-12 text-center">
                <h3>No Active Auctions</h3>
                <p>Check back later for new auction listings!</p>
                <a href="/listings/new" class="btn btn-primary">Create New Listing</a>
            </div>
        <% } else { %>
            <% auctions.forEach(auction => { %>
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="auction-card auction-<%= auction.status %>">
                        <div class="status-badge <%= auction.status %>-badge">
                            <%= auction.status === 'live' ? 'LIVE' : 
                                auction.status === 'ending-soon' ? 'ENDING SOON' : 'ENDED' %>
                        </div>
                        <div class="card-body p-0">
                            <% if (auction.image) { %>
                                <img src="<%= auction.image.url %>" class="card-img-top property-image" alt="<%= auction.title %>">
                            <% } else { %>
                                <div class="property-image bg-light d-flex align-items-center justify-content-center">
                                    <i class="fas fa-home fa-3x text-muted"></i>
                                </div>
                            <% } %>
                            
                            <div class="p-3">
                                <h5 class="card-title"><%= auction.title %></h5>
                                <p class="card-text text-muted small"><%= auction.description %></p>
                                <p class="card-text">
                                    <i class="fas fa-map-marker-alt text-danger"></i> 
                                    <%= auction.location %>, <%= auction.country %>
                                </p>
                                
                                <div class="bid-section">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="small text-muted">Current Bid</span>
                                        <span class="small text-muted"><%= auction.totalBids || 0 %> bids</span>
                                    </div>
                                    <div class="current-bid">₹<%= (auction.currentBid || auction.price).toLocaleString() %></div>
<small class="text-muted">Starting: ₹<%= auction.price.toLocaleString() %> | Current: ₹<%= (auction.currentBid || 0).toLocaleString() %></small>
                                    
                                    <% if (auction.status !== 'ended') { %>
                                        <div class="mt-3 mb-2">
                                            <div class="timer" data-end-time="<%= auction.auctionEndTime.toISOString() %>">
                                                <i class="fas fa-clock text-warning"></i> 
                                                <span class="countdown">Calculating...</span>
                                            </div>
                                        </div>
                                        
                                        <% if (currentUser) { %>
                                            <button class="btn bid-button w-100" onclick="openBidModal('<%= auction._id %>', <%= auction.currentBid || auction.price %>)">
                                                <i class="fas fa-gavel"></i> Place Bid
                                            </button>
                                        <% } else { %>
                                            <a href="/login" class="btn btn-outline-primary w-100">
                                                Login to Bid
                                            </a>
                                        <% } %>
                                    <% } else { %>
                                        <div class="mt-3">
                                            <button class="btn btn-secondary w-100" disabled>
                                                Auction Ended
                                            </button>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <% }); %>
        <% } %>
    </div>
</div>

<!-- Bid Modal -->
<div class="modal fade" id="bidModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Place Your Bid</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Current Highest Bid</label>
                    <div class="current-bid" id="modalCurrentBid">₹0</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Your Bid Amount (₹)</label>
                    <input type="number" class="form-control" id="bidAmount" placeholder="Enter your bid">
                    <div class="form-text">Minimum bid: ₹<span id="minBid">0</span></div>
                </div>
                <input type="hidden" id="auctionId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn bid-button" id="submitBid">Place Bid</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentAuctionId = null;

    // Setup countdown timers
    function setupTimers() {
        setInterval(() => {
            document.querySelectorAll('.countdown').forEach(element => {
                const timer = element.closest('.timer');
                const endTime = new Date(timer.dataset.endTime);
                const now = new Date();
                const diff = endTime - now;

                if (diff > 0) {
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    element.textContent = `${hours}h ${minutes}m ${seconds}s`;
                } else {
                    element.textContent = 'Auction Ended';
                }
            });
        }, 1000);
    }

    // Open bid modal
    function openBidModal(auctionId, currentBid) {
        currentAuctionId = auctionId;
        document.getElementById('modalCurrentBid').textContent = '₹' + currentBid.toLocaleString();
        document.getElementById('minBid').textContent = (currentBid + 50000).toLocaleString();
        document.getElementById('bidAmount').value = '';
        document.getElementById('auctionId').value = auctionId;
        
        new bootstrap.Modal(document.getElementById('bidModal')).show();
    }

    // Submit bid
    document.getElementById('submitBid').addEventListener('click', async function() {
        const auctionId = document.getElementById('auctionId').value;
        const bidAmount = parseInt(document.getElementById('bidAmount').value);
        
        if (!bidAmount) {
            alert('Please enter a bid amount');
            return;
        }
        
        try {
            const response = await fetch(`/listings/auction/${auctionId}/bid`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ bidAmount })
            });
            
            const result = await response.json();
            
            if (result.success) {
                bootstrap.Modal.getInstance(document.getElementById('bidModal')).hide();
                location.reload(); // Refresh to show updated bid
            } else {
                alert(result.error || 'Failed to place bid');
            }
        } catch (error) {
            alert('Error placing bid. Please try again.');
            console.error('Bid error:', error);
        }
    });

    // Initialize timers when page loads
    document.addEventListener('DOMContentLoaded', setupTimers);
</script>

<%- include("../includes/footer") %>